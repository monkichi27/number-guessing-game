<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏Å‡∏°‡∏ó‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 4 ‡∏´‡∏•‡∏±‡∏Å - ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .game-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 900px;
            overflow: hidden;
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }
        
        .connection-status {
            position: absolute;
            top: 15px;
            right: 20px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .connected { background: #4CAF50; }
        .waiting { background: #FF9800; }
        .disconnected { background: #f44336; }
        .reconnecting { background: #2196F3; animation: pulse 1s infinite; }
        
        .info-btn {
            position: absolute;
            top: 15px;
            left: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .info-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }
        
        .lobby-phase, .setup-phase, .game-phase {
            padding: 30px;
        }
        
        .setup-phase, .game-phase {
            display: none;
        }
        
        .room-section {
            background: #f8f9fc;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            text-align: center;
        }
        
        .room-code {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
            letter-spacing: 5px;
            background: #e8f2ff;
            padding: 15px;
            border-radius: 10px;
            display: inline-block;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .room-code:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .room-code:hover::after {
            content: ' üìã ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å';
            font-size: 0.4em;
            display: block;
            margin-top: 5px;
            color: #666;
        }
        
        .player-section {
            background: #f8f9fc;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid #667eea;
            transition: all 0.3s ease;
        }
        
        .player-section.active {
            background: #e8f4fd;
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }
        
        .player-section.my-turn {
            border-left-color: #4CAF50;
            background: #f1f8e9;
        }
        
        .player-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .player-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .player1 .player-icon { background: #667eea; }
        .player2 .player-icon { background: #764ba2; }
        
        input[type="text"] {
            width: 250px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1.2em;
            text-align: center;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .secret-input {
            letter-spacing: 8px;
        }
        
        .room-input {
            letter-spacing: 3px;
            text-transform: uppercase;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.3);
            transform: translateY(-2px);
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 8px;
            font-weight: bold;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }
        
        .current-turn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.3em;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        
        .waiting-turn {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            animation: none;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
        }
        
        .guess-section {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .result-section {
            background: #e8f4fd;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            font-size: 1.1em;
        }
        
        .history {
            background: #f5f5f5;
            border-radius: 15px;
            padding: 25px;
            margin-top: 25px;
            max-height: 350px;
            overflow-y: auto;
        }
        
        .history h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .history-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea;
            font-size: 1.05em;
            transition: transform 0.2s ease;
        }
        
        .history-item:hover {
            transform: translateX(5px);
        }
        
        .history-item.my-guess {
            border-left-color: #4CAF50;
            background: #f1f8e9;
        }
        
        .history-item.opponent-guess {
            border-left-color: #FF9800;
            background: #fff3e0;
        }
        
        .winner-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .winner-content {
            background: white;
            padding: 50px;
            border-radius: 25px;
            text-align: center;
            max-width: 450px;
            animation: celebration 0.8s ease;
        }
        
        @keyframes celebration {
            0% { transform: scale(0.5) rotate(-180deg); opacity: 0; }
            50% { transform: scale(1.1) rotate(0deg); opacity: 0.8; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        
        .rules {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .rules h3 {
            color: #856404;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .rules ul {
            color: #856404;
            margin-left: 25px;
            line-height: 1.6;
        }
        
        .waiting-message {
            text-align: center;
            padding: 30px;
            background: #e8f4fd;
            border-radius: 15px;
            margin: 20px 0;
        }
        
        .waiting-animation {
            display: inline-block;
            animation: bounce 1.5s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        .notification {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
        }
        
        .notification.success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .notification.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .notification.warning {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        
        .reconnect-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .reconnect-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .reconnect-content h3 {
            color: #FF9800;
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        
        .reconnect-content p {
            color: #666;
            margin-bottom: 20px;
        }
        
        .countdown {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
        }
        
        .reconnect-progress {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            border-radius: 4px;
            transition: width 1s ease;
        }
        
        .reconnection-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(33, 150, 243, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            color: white;
            flex-direction: column;
        }
        
        .reconnection-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top: 5px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .session-restore-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 4000;
        }
        
        .session-restore-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 450px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }
        
        .session-restore-content h3 {
            color: #2196F3;
            margin-bottom: 15px;
            font-size: 1.6em;
        }
        
        @media (max-width: 600px) {
            .game-container {
                margin: 10px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .room-code {
                font-size: 2em;
                letter-spacing: 3px;
            }
            
            .guess-section {
                flex-direction: column;
                align-items: stretch;
            }
            
            input[type="text"] {
                width: 100%;
                margin-bottom: 15px;
            }
            
            .connection-status, .info-btn {
                position: static;
                margin: 10px auto;
                display: inline-block;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <button class="info-btn" onclick="showInstructions()">‚ùì</button>
            <h1>üéØ ‡πÄ‡∏Å‡∏°‡∏ó‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 4 ‡∏´‡∏•‡∏±‡∏Å</h1>
            <p>‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏ö‡∏ö Real-time</p>
            <div class="connection-status disconnected" id="connectionStatus">
                üî¥ ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
            </div>
        </div>
        
        <!-- Lobby Phase -->
        <div class="lobby-phase" id="lobbyPhase">
            <div class="rules">
                <h3>üìã ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô</h3>
                <ul>
                    <li>‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 4 ‡∏´‡∏•‡∏±‡∏Å (‡∏´‡πâ‡∏≤‡∏°‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô)</li>
                    <li>‡∏ú‡∏•‡∏±‡∏î‡∏Å‡∏±‡∏ô‡∏ó‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Ç‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢</li>
                    <li>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤ "‡∏ñ‡∏π‡∏Å‡∏Å‡∏µ‡πà‡∏´‡∏•‡∏±‡∏Å ‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏Ç‡∏Å‡∏µ‡πà‡∏ï‡∏±‡∏ß"</li>
                    <li>‡πÉ‡∏Ñ‡∏£‡∏ó‡∏≤‡∏¢‡∏ñ‡∏π‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏ä‡∏ô‡∏∞!</li>
                </ul>
            </div>
            
            <div class="room-section">
                <h2>üö™ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏Å‡∏°</h2>
                <div style="margin: 25px 0;">
                    <button class="btn btn-secondary" onclick="createRoom()">üéÆ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
                    <span style="margin: 0 20px; color: #666; font-weight: bold;">‡∏´‡∏£‡∏∑‡∏≠</span>
                    <button class="btn" onclick="showJoinRoom()">üîó ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á</button>
                </div>
                
                <div id="joinRoomSection" style="display: none; margin-top: 25px;">
                    <input type="text" id="roomCodeInput" class="room-input" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á" maxlength="6">
                    <br>
                    <button class="btn" onclick="joinRoom()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</button>
                    <button class="btn" onclick="hideJoinRoom()" style="background: #6c757d;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
                
                <div id="notification" class="notification" style="display: none;"></div>
            </div>
        </div>
        
        <!-- Setup Phase -->
        <div class="setup-phase" id="setupPhase">
            <div class="room-section">
                <h3>üè† ‡∏´‡πâ‡∏≠‡∏á</h3>
                <div class="room-code" id="displayRoomCode" onclick="copyRoomCode()">ABC123</div>
                <p>‡πÅ‡∏ä‡∏£‡πå‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏Å‡∏°</p>
                <div style="margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="copyRoomCode()">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™</button>
                    <button class="btn" onclick="shareRoomCode()">üì§ ‡πÅ‡∏ä‡∏£‡πå</button>
                    <button class="btn" onclick="shareNgrokLink()" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">üåê ‡πÅ‡∏ä‡∏£‡πå‡∏•‡∏¥‡∏á‡∏Å‡πå</button>
                </div>
                <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                    <span id="currentUrl"></span>
                </div>
            </div>
            
            <div class="waiting-message" id="waitingMessage">
                <div class="waiting-animation">‚è≥</div>
                <h3>‡∏£‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 2...</h3>
                <p>‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</p>
            </div>
            
            <div id="bothPlayersReady" style="display: none;">
                <div class="player-section" id="myPlayerSection">
                    <div class="player-title">
                        <div class="player-icon">üë§</div>
                        <span id="myPlayerName">‡∏Ñ‡∏∏‡∏ì</span>
                    </div>
                    <div>
                        <label>‡∏ï‡∏±‡πâ‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 4 ‡∏´‡∏•‡∏±‡∏Å:</label>
                        <input type="text" id="mySecret" class="secret-input" maxlength="4" placeholder="1234">
                        <button class="btn" onclick="submitSecret()">üîí ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                        <div id="mySecretError" style="color: red; margin-top: 8px;"></div>
                    </div>
                </div>
                
                <div class="player-section" id="opponentPlayerSection">
                    <div class="player-title">
                        <div class="player-icon">üë•</div>
                        <span id="opponentPlayerName">‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢</span>
                    </div>
                    <div id="opponentStatus">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç...</div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 25px;">
                <button class="btn btn-danger" onclick="leaveRoom()">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á</button>
            </div>
        </div>
        
        <!-- Game Phase -->
        <div class="game-phase" id="gamePhase">
            <div class="current-turn" id="currentTurn">
                ‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì - ‡∏ó‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Ç‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢
            </div>
            
            <div class="player-section" id="gameSection">
                <div class="guess-section">
                    <label style="font-weight: bold; font-size: 1.1em;">‡∏ó‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç:</label>
                    <input type="text" id="guessInput" class="secret-input" maxlength="4" placeholder="0000">
                    <button class="btn" onclick="makeGuess()">üéØ ‡∏ó‡∏≤‡∏¢</button>
                </div>
                <div class="result-section" id="resultSection" style="display: none;">
                    <div id="guessResult"></div>
                </div>
            </div>
            
            <div class="history">
                <h3>üìù ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏¢</h3>
                <div id="gameHistory">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏¢</div>
            </div>
            
            <div style="text-align: center; margin-top: 25px;">
                <button class="btn" onclick="resetGame()">üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
                <button class="btn btn-danger" onclick="leaveRoom()">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á</button>
            </div>
        </div>
    </div>
    
    <!-- Winner Popup -->
    <div class="winner-popup" id="winnerPopup">
        <div class="winner-content">
            <h2 id="winnerText">üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢!</h2>
            <p id="winnerDetail" style="margin: 20px 0; font-size: 1.1em;"></p>
            <button class="btn" onclick="resetGame()">üéÆ ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
            <button class="btn btn-danger" onclick="leaveRoom()">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á</button>
        </div>
    </div>
    
    <!-- Reconnection Overlay -->
    <div class="reconnection-overlay" id="reconnectionOverlay">
        <div class="reconnection-spinner"></div>
        <h3>üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö...</h3>
        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p>
    </div>
    
    <!-- Session Restore Dialog -->
    <div class="session-restore-dialog" id="sessionRestoreDialog">
        <div class="session-restore-content">
            <h3>üéÆ ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°</h3>
            <p>‡∏û‡∏ö‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
            <div style="margin: 20px 0;">
                <strong>‡∏´‡πâ‡∏≠‡∏á:</strong> <span id="restoreRoomCode"></span><br>
                <strong>‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô:</strong> <span id="restorePlayerNumber"></span>
            </div>
            <button class="btn btn-secondary" onclick="restoreSession()">üîÑ ‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πà‡∏≠</button>
            <button class="btn" onclick="startNewSession()">üÜï ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
        </div>
    </div>

    <script>
        // Game State with improved session management
        let gameState = {
            socket: null,
            roomCode: '',
            playerNumber: 0,
            playerId: '',
            isMyTurn: false,
            gameStarted: false,
            mySecret: '',
            secretSubmitted: false,
            isReconnecting: false,
            reconnectAttempts: 0,
            maxReconnectAttempts: 5,
            heartbeatInterval: null,
            lastPingTime: null
        };

        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô double-click
        let actionInProgress = {
            makeGuess: false,
            submitSecret: false,
            joinRoom: false,
            createRoom: false
        };

        // Session Management (‡πÉ‡∏ä‡πâ in-memory ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å artifacts ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö localStorage)
        const SessionManager = {
            session: null,
            
            saveSession: function(data) {
                try {
                    this.session = {
                        roomCode: data.roomCode,
                        playerNumber: data.playerNumber,
                        playerId: data.playerId,
                        timestamp: Date.now(),
                        gameStarted: data.gameStarted || false,
                        mySecret: data.mySecret || ''
                    };
                    console.log('üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å session:', this.session);
                } catch (e) {
                    console.warn('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å session:', e);
                }
            },
            
            loadSession: function() {
                try {
                    if (this.session) {
                        const age = Date.now() - this.session.timestamp;
                        
                        // Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô 30 ‡∏ô‡∏≤‡∏ó‡∏µ
                        if (age < 30 * 60 * 1000) {
                            return this.session;
                        } else {
                            this.clearSession();
                        }
                    }
                } catch (e) {
                    console.warn('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î session:', e);
                    this.clearSession();
                }
                return null;
            },
            
            clearSession: function() {
                this.session = null;
            },
            
            updateSession: function(updates) {
                if (this.session) {
                    this.session = { ...this.session, ...updates };
                }
            }
        };

        // Initialize Socket Connection with improved reconnection
        function initSocket() {
            const socket = io({
                timeout: 20000,
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000,
                maxReconnectionAttempts: 10
            });
            
            gameState.socket = socket;
            
            // Connection events
            socket.on('connect', () => {
                console.log('üîó ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                updateConnectionStatus('connected');
                startHeartbeat();
                gameState.reconnectAttempts = 0;
                gameState.isReconnecting = false;
                
                hideReconnectionOverlay();
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö session ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
                const savedSession = SessionManager.loadSession();
                if (savedSession && !gameState.roomCode) {
                    showSessionRestoreDialog(savedSession);
                }
                
                // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á reconnect ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏° ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏ï‡πà‡∏≠
                if (gameState.roomCode && gameState.playerNumber && !gameState.gameStarted) {
                    setTimeout(() => {
                        attemptGameReconnect();
                    }, 500);
                }
            });
            
            socket.on('disconnect', (reason) => {
                console.log('‚ùå ‡∏´‡∏•‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠:', reason);
                updateConnectionStatus('disconnected');
                
                if (gameState.heartbeatInterval) {
                    clearInterval(gameState.heartbeatInterval);
                    gameState.heartbeatInterval = null;
                }
                
                if (gameState.roomCode && reason !== 'io client disconnect') {
                    attemptReconnection();
                }
            });
            
            socket.on('connect_error', (error) => {
                console.error('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠:', error);
                updateConnectionStatus('disconnected');
                
                if (gameState.roomCode) {
                    attemptReconnection();
                }
            });
            
            // Room events
            socket.on('roomUpdate', (data) => {
                console.log('üè† ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡πâ‡∏≠‡∏á:', data);
                updateRoomDisplay(data);
            });
            
            socket.on('gameStart', (data) => {
                console.log('üéÆ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°:', data);
                startGame(data);
                SessionManager.updateSession({ gameStarted: true });
            });
            
            socket.on('turnChange', (data) => {
                console.log('üîÑ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≤:', data);
                updateTurn(data);
                updateGameHistory(data.history);
            });
            
            socket.on('gameEnd', (data) => {
                console.log('üèÜ ‡∏à‡∏ö‡πÄ‡∏Å‡∏°:', data);
                showWinner(data);
                updateGameHistory(data.history);
                hideReconnectDialog();
                SessionManager.clearSession();
            });
            
            socket.on('gameReset', (data) => {
                console.log('üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏Å‡∏°:', data);
                resetGameState();
                SessionManager.updateSession({ gameStarted: false, mySecret: '' });
            });
            
            socket.on('playerLeft', (data) => {
                console.log('üö™ ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á:', data);
                showNotification(`‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà ${data.playerNumber} ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á`, 'warning');
                updateRoomDisplay({ players: data.players });
            });
            
            socket.on('playerDisconnected', (data) => {
                console.log('üì¥ ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏´‡∏•‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠:', data);
                
                if (data.playerNumber !== gameState.playerNumber) {
                    showReconnectDialog(data.playerNumber, data.reconnectTimeLeft);
                }
            });
            
            socket.on('reconnectCountdown', (data) => {
                updateReconnectCountdown(data.timeLeft);
            });
            
            socket.on('playerReconnected', (data) => {
                console.log('üîÑ ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠:', data);
                hideReconnectDialog();
                showNotification(`‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà ${data.playerNumber} ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß!`, 'success');
            });
            
            socket.on('stopReconnectCountdown', (data) => {
                console.log('‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î countdown:', data.playerNumber);
                hideReconnectDialog();
                showNotification(`‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà ${data.playerNumber} ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß - ‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ!`, 'success');
            });
            
            return socket;
        }

        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            
            switch(status) {
                case 'connected':
                    statusElement.className = 'connection-status connected';
                    statusElement.innerHTML = 'üü¢ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß';
                    break;
                case 'waiting':
                    statusElement.className = 'connection-status waiting';
                    statusElement.innerHTML = 'üü° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...';
                    break;
                case 'reconnecting':
                    statusElement.className = 'connection-status reconnecting';
                    statusElement.innerHTML = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö...';
                    break;
                default:
                    statusElement.className = 'connection-status disconnected';
                    statusElement.innerHTML = 'üî¥ ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
            }
        }

        function attemptReconnection() {
            if (gameState.isReconnecting) return;
            
            console.log('üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö');
            
            gameState.isReconnecting = true;
            gameState.reconnectAttempts = 0;
            
            updateConnectionStatus('reconnecting');
            
            // ‡πÅ‡∏™‡∏î‡∏á overlay ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏°
            if (gameState.roomCode) {
                showReconnectionOverlay();
            }
            
            const reconnectInterval = setInterval(() => {
                gameState.reconnectAttempts++;
                console.log(`üîÑ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${gameState.reconnectAttempts}/${gameState.maxReconnectAttempts}`);
                
                if (gameState.socket && gameState.socket.connected) {
                    console.log('‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    clearInterval(reconnectInterval);
                    gameState.isReconnecting = false;
                    hideReconnectionOverlay();
                    
                    // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° reconnect ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
                    if (gameState.roomCode && gameState.playerNumber) {
                        setTimeout(() => {
                            attemptGameReconnect();
                        }, 1000);
                    }
                    return;
                }
                
                if (gameState.reconnectAttempts >= gameState.maxReconnectAttempts) {
                    console.log('‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    clearInterval(reconnectInterval);
                    gameState.isReconnecting = false;
                    hideReconnectionOverlay();
                    
                    showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï', 'error');
                    updateConnectionStatus('disconnected');
                    
                    // ‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                    setTimeout(() => {
                        if (confirm('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                            window.location.reload();
                        }
                    }, 2000);
                    return;
                }
            }, 2000);
        }

        function attemptGameReconnect() {
            if (!gameState.roomCode || !gameState.playerNumber) {
                console.log('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö reconnect');
                return;
            }
            
            console.log(`üéÆ ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° reconnect ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°: Room ${gameState.roomCode}, Player ${gameState.playerNumber}`);
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
            showReconnectionOverlay();
            
            // ‡∏ï‡∏±‡πâ‡∏á timeout ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á
            const reconnectTimeout = setTimeout(() => {
                hideReconnectionOverlay();
                showNotification('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'warning');
                validateAndFixUI();
            }, 15000);
            
            gameState.socket.emit('attemptReconnect', {
                roomCode: gameState.roomCode,
                playerNumber: gameState.playerNumber
            }, (response) => {
                clearTimeout(reconnectTimeout);
                hideReconnectionOverlay();
                gameState.isReconnecting = false;
                
                if (response && response.success) {
                    console.log('‚úÖ Reconnect ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    
                    // ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Å‡∏°
                    gameState.gameStarted = response.gameState.started;
                    gameState.isMyTurn = response.gameState.currentPlayer === gameState.playerNumber;
                    
                    if (response.mySecret) {
                        gameState.mySecret = response.mySecret;
                        gameState.secretSubmitted = true;
                    }
                    
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
                    if (response.gameState.started) {
                        document.getElementById('lobbyPhase').style.display = 'none';
                        document.getElementById('setupPhase').style.display = 'none';
                        document.getElementById('gamePhase').style.display = 'block';
                        updateCurrentTurn();
                        updateGameHistory(response.gameState.history);
                    } else {
                        document.getElementById('lobbyPhase').style.display = 'none';
                        document.getElementById('setupPhase').style.display = 'block';
                        document.getElementById('gamePhase').style.display = 'none';
                        updateRoomDisplay({ players: response.players });
                        
                        if (gameState.secretSubmitted) {
                            markSecretAsSubmitted();
                        }
                    }
                    
                    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç UI ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å reconnect
                    setTimeout(() => {
                        validateAndFixUI();
                    }, 500);
                    
                    showNotification('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                } else {
                    console.log('‚ùå Reconnect ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:', response ? response.message : '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö');
                    showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡πÑ‡∏î‡πâ: ' + (response ? response.message : '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö'), 'error');
                    
                    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç UI ‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ lobby
                    validateAndFixUI();
                    setTimeout(() => {
                        leaveRoom();
                    }, 2000);
                }
            });
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Å‡∏°
        function checkGameState() {
            if (!gameState.socket) {
                console.log('‚ö†Ô∏è Socket ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                return false;
            }
            
            if (!gameState.socket.connected) {
                console.log('‚ö†Ô∏è Socket ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
                if (!gameState.isReconnecting) {
                    attemptReconnection();
                }
                return false;
            }
            
            return true;
        }

        function createRoom() {
            if (actionInProgress.createRoom) {
                console.log('üö´ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠...');
                return;
            }
            
            if (!checkGameState()) {
                showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏î‡πâ', 'error');
                return;
            }
            
            actionInProgress.createRoom = true;
            const createBtn = document.querySelector('.btn-secondary');
            createBtn.disabled = true;
            createBtn.textContent = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á...';
            
            const timeout = setTimeout(() => {
                actionInProgress.createRoom = false;
                createBtn.disabled = false;
                createBtn.textContent = 'üéÆ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
                showNotification('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ä‡πâ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'warning');
            }, 8000);
            
            gameState.socket.emit('createRoom', (response) => {
                clearTimeout(timeout);
                actionInProgress.createRoom = false;
                createBtn.disabled = false;
                createBtn.textContent = 'üéÆ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
                
                if (response && response.success) {
                    gameState.roomCode = response.roomCode;
                    gameState.playerNumber = response.playerNumber;
                    gameState.playerId = gameState.socket.id;
                    
                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å session
                    SessionManager.saveSession({
                        roomCode: gameState.roomCode,
                        playerNumber: gameState.playerNumber,
                        playerId: gameState.playerId
                    });
                    
                    document.getElementById('displayRoomCode').textContent = response.roomCode;
                    document.getElementById('lobbyPhase').style.display = 'none';
                    document.getElementById('setupPhase').style.display = 'block';
                    document.getElementById('currentUrl').textContent = window.location.origin;
                    
                    showNotification(`‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á ${response.roomCode} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`, 'success');
                } else {
                    showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ', 'error');
                }
            });
        }

        function showJoinRoom() {
            document.getElementById('joinRoomSection').style.display = 'block';
            document.getElementById('roomCodeInput').focus();
        }

        function hideJoinRoom() {
            document.getElementById('joinRoomSection').style.display = 'none';
            document.getElementById('roomCodeInput').value = '';
        }

        function joinRoom() {
            if (actionInProgress.joinRoom) {
                console.log('üö´ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠...');
                return;
            }
            
            const roomCode = document.getElementById('roomCodeInput').value.toUpperCase().trim();
            const joinBtn = document.querySelector('#joinRoomSection .btn');
            
            if (roomCode.length !== 6) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á 6 ‡∏´‡∏•‡∏±‡∏Å', 'error');
                return;
            }
            
            if (!checkGameState()) {
                showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏î‡πâ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...', 'warning');
                return;
            }
            
            actionInProgress.joinRoom = true;
            // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°
            joinBtn.disabled = true;
            joinBtn.textContent = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°...';
            
            // ‡∏ï‡∏±‡πâ‡∏á timeout
            const timeout = setTimeout(() => {
                actionInProgress.joinRoom = false;
                joinBtn.disabled = false;
                joinBtn.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°';
                showNotification('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ä‡πâ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'warning');
            }, 8000);
            
            gameState.socket.emit('joinRoom', { roomCode }, (response) => {
                clearTimeout(timeout);
                actionInProgress.joinRoom = false;
                joinBtn.disabled = false;
                joinBtn.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°';
                
                if (response && response.success) {
                    gameState.roomCode = response.roomCode;
                    gameState.playerNumber = response.playerNumber;
                    gameState.playerId = gameState.socket.id;
                    
                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å session
                    SessionManager.saveSession({
                        roomCode: gameState.roomCode,
                        playerNumber: gameState.playerNumber,
                        playerId: gameState.playerId
                    });
                    
                    document.getElementById('displayRoomCode').textContent = response.roomCode;
                    document.getElementById('lobbyPhase').style.display = 'none';
                    document.getElementById('setupPhase').style.display = 'block';
                    document.getElementById('waitingMessage').style.display = 'none';
                    document.getElementById('bothPlayersReady').style.display = 'block';
                    document.getElementById('currentUrl').textContent = window.location.origin;
                    
                    showNotification(`‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á ${response.roomCode} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`, 'success');
                } else if (response) {
                    showNotification(response.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
                } else {
                    showNotification('‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å Server', 'error');
                    
                    if (!gameState.socket.connected && !gameState.isReconnecting) {
                        attemptReconnection();
                    }
                }
            });
        }

        function updateRoomDisplay(data) {
            const playerCount = Object.keys(data.players).length;
            
            if (playerCount === 2) {
                document.getElementById('waitingMessage').style.display = 'none';
                document.getElementById('bothPlayersReady').style.display = 'block';
                
                const myPlayerSection = document.getElementById('myPlayerSection');
                const opponentPlayerSection = document.getElementById('opponentPlayerSection');
                
                myPlayerSection.className = `player-section player${gameState.playerNumber}`;
                const opponentNumber = gameState.playerNumber === 1 ? 2 : 1;
                opponentPlayerSection.className = `player-section player${opponentNumber}`;
                
                const allReady = Object.values(data.players).every(p => p.ready);
                if (allReady) {
                    document.getElementById('opponentStatus').textContent = '‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß';
                } else {
                    document.getElementById('opponentStatus').textContent = '‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç...';
                }
            } else {
                document.getElementById('waitingMessage').style.display = 'block';
                document.getElementById('bothPlayersReady').style.display = 'none';
            }
        }

        function submitSecret() {
            if (actionInProgress.submitSecret) {
                console.log('üö´ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏•‡∏±‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠...');
                return;
            }
            
            const secret = document.getElementById('mySecret').value.trim();
            const errorElement = document.getElementById('mySecretError');
            const submitBtn = document.querySelector('#myPlayerSection .btn');
            
            errorElement.textContent = '';
            
            if (!validateNumber(secret)) {
                errorElement.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 4 ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô';
                return;
            }
            
            if (!checkGameState()) {
                errorElement.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏î‡πâ';
                return;
            }
            
            if (gameState.secretSubmitted) {
                errorElement.textContent = '‡∏™‡πà‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡πâ‡∏ß';
                errorElement.style.color = 'green';
                return;
            }
            
            // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô double-click
            actionInProgress.submitSecret = true;
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á
            submitBtn.disabled = true;
            submitBtn.textContent = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';
            
            // ‡∏ï‡∏±‡πâ‡∏á timeout
            const timeout = setTimeout(() => {
                actionInProgress.submitSecret = false;
                submitBtn.disabled = false;
                submitBtn.textContent = 'üîí ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
                errorElement.textContent = '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ä‡πâ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
                
                if (!gameState.socket.connected && !gameState.isReconnecting) {
                    attemptReconnection();
                }
            }, 8000); // 8 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            
            gameState.socket.emit('submitSecret', { secret }, (response) => {
                clearTimeout(timeout);
                actionInProgress.submitSecret = false;
                submitBtn.disabled = false;
                submitBtn.textContent = 'üîí ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
                
                if (response && response.success) {
                    gameState.mySecret = secret;
                    gameState.secretSubmitted = true;
                    
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï session
                    SessionManager.updateSession({ mySecret: secret });
                    
                    markSecretAsSubmitted();
                    showNotification('‡∏™‡πà‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏•‡∏±‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                } else if (response) {
                    errorElement.textContent = response.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
                } else {
                    errorElement.textContent = '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å Server';
                    
                    if (!gameState.socket.connected && !gameState.isReconnecting) {
                        attemptReconnection();
                    }
                }
            });
        }

        function markSecretAsSubmitted() {
            document.getElementById('mySecret').style.display = 'none';
            document.getElementById('mySecret').previousElementSibling.style.display = 'none';
            document.querySelector('#myPlayerSection .btn').style.display = 'none';
            
            const errorElement = document.getElementById('mySecretError');
            errorElement.textContent = '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡πâ‡∏ß';
            errorElement.style.color = 'green';
        }

        function startGame(data) {
            gameState.gameStarted = true;
            gameState.isMyTurn = (data.currentPlayer === gameState.playerNumber);
            
            document.getElementById('setupPhase').style.display = 'none';
            document.getElementById('gamePhase').style.display = 'block';
            
            updateCurrentTurn();
            document.getElementById('gameHistory').innerHTML = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏¢';
            document.getElementById('resultSection').style.display = 'none';
            
            showNotification('‡πÄ‡∏Å‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß!', 'success');
        }

        function updateCurrentTurn() {
            const turnElement = document.getElementById('currentTurn');
            const gameSection = document.getElementById('gameSection');
            
            if (gameState.isMyTurn) {
                turnElement.textContent = 'üéØ ‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì - ‡∏ó‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Ç‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢';
                turnElement.className = 'current-turn';
                gameSection.style.display = 'block';
            } else {
                turnElement.textContent = '‚è≥ ‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢ - ‡∏£‡∏≠‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö...';
                turnElement.className = 'current-turn waiting-turn';
                gameSection.style.display = 'none';
            }
        }

        function updateTurn(data) {
            gameState.isMyTurn = (data.currentPlayer === gameState.playerNumber);
            updateCurrentTurn();
            
            // ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏´‡∏°‡πà
            const guessInput = document.getElementById('guessInput');
            const guessBtn = document.querySelector('#gameSection .btn');
            
            guessInput.value = '';
            guessInput.disabled = false;
            guessBtn.disabled = false;
            guessBtn.textContent = 'üéØ ‡∏ó‡∏≤‡∏¢';
            
            document.getElementById('resultSection').style.display = 'none';
        }

        function makeGuess() {
            if (actionInProgress.makeGuess) {
                console.log('üö´ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠...');
                return;
            }
            
            const guess = document.getElementById('guessInput').value.trim();
            const guessBtn = document.querySelector('#gameSection .btn');
            
            if (!validateNumber(guess)) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 4 ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô', 'error');
                return;
            }
            
            if (!checkGameState()) {
                showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏î‡πâ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà...', 'warning');
                return;
            }
            
            if (!gameState.isMyTurn) {
                showNotification('‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì', 'warning');
                return;
            }
            
            // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô double-click
            actionInProgress.makeGuess = true;
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
            guessBtn.disabled = true;
            guessBtn.textContent = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≤‡∏¢...';
            
            // ‡∏ï‡∏±‡πâ‡∏á timeout ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á
            const timeout = setTimeout(() => {
                actionInProgress.makeGuess = false;
                guessBtn.disabled = false;
                guessBtn.textContent = 'üéØ ‡∏ó‡∏≤‡∏¢';
                showNotification('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ä‡πâ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'warning');
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° reconnect ‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
                if (!gameState.socket.connected && !gameState.isReconnecting) {
                    attemptReconnection();
                }
            }, 10000); // 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            
            gameState.socket.emit('makeGuess', { guess }, (response) => {
                clearTimeout(timeout);
                actionInProgress.makeGuess = false;
                guessBtn.disabled = false;
                guessBtn.textContent = 'üéØ ‡∏ó‡∏≤‡∏¢';
                
                if (response && response.success) {
                    const resultSection = document.getElementById('resultSection');
                    const resultElement = document.getElementById('guessResult');
                    
                    let resultText = `üéØ ‡∏ó‡∏≤‡∏¢: ${guess} ‚Üí `;
                    if (response.isWin) {
                        resultText += 'üéâ ‡∏ñ‡∏π‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î! ‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏ô‡∏∞‡πÅ‡∏•‡πâ‡∏ß!';
                    } else {
                        resultText += `‡∏ñ‡∏π‡∏Å ${response.result.correctPosition} ‡∏´‡∏•‡∏±‡∏Å, ‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏Ç ${response.result.correctNumber} ‡∏ï‡∏±‡∏ß`;
                    }
                    
                    resultElement.innerHTML = resultText;
                    resultSection.style.display = 'block';
                    
                    if (!response.isWin) {
                        gameState.isMyTurn = false;
                        updateCurrentTurn();
                        
                        // ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏¢
                        document.getElementById('guessInput').value = '';
                    }
                } else if (response) {
                    showNotification(response.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
                } else {
                    showNotification('‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å Server', 'error');
                    
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
                    if (!gameState.socket.connected && !gameState.isReconnecting) {
                        attemptReconnection();
                    }
                }
            });
        }

        function updateGameHistory(history) {
            const historyElement = document.getElementById('gameHistory');
            
            if (!history || history.length === 0) {
                historyElement.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏¢</p>';
                return;
            }
            
            historyElement.innerHTML = '';
            
            history.slice().reverse().forEach((item) => {
                const historyItem = document.createElement('div');
                
                const isMyGuess = item.player === gameState.playerNumber;
                historyItem.className = `history-item ${isMyGuess ? 'my-guess' : 'opponent-guess'}`;
                
                const playerName = isMyGuess ? 'üéØ ‡∏Ñ‡∏∏‡∏ì' : 'üë§ ‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢';
                let resultText = `${playerName}: ‡∏ó‡∏≤‡∏¢ ${item.guess} ‚Üí `;
                
                if (item.isWin) {
                    resultText += 'üéâ ‡∏ñ‡∏π‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î! ‡∏ä‡∏ô‡∏∞!';
                } else {
                    resultText += `‡∏ñ‡∏π‡∏Å ${item.result.correctPosition} ‡∏´‡∏•‡∏±‡∏Å, ‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏Ç ${item.result.correctNumber} ‡∏ï‡∏±‡∏ß`;
                }
                
                historyItem.innerHTML = resultText;
                historyElement.appendChild(historyItem);
            });
        }

        function showWinner(data) {
            const popup = document.getElementById('winnerPopup');
            const winnerText = document.getElementById('winnerText');
            const winnerDetail = document.getElementById('winnerDetail');
            
            if (data.winner === gameState.playerNumber) {
                winnerText.textContent = 'üéâ ‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏ô‡∏∞!';
                winnerDetail.textContent = data.winnerDetail || `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≤‡∏¢‡∏ñ‡∏π‡∏Å: ${data.winningGuess}`;
            } else {
                winnerText.textContent = 'üòÖ ‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡∏ä‡∏ô‡∏∞!';
                winnerDetail.textContent = data.winnerDetail || `${data.winnerName} ‡∏ó‡∏≤‡∏¢‡∏ñ‡∏π‡∏Å: ${data.winningGuess}`;
            }
            
            popup.style.display = 'flex';
        }

        function resetGame() {
            gameState.socket.emit('resetGame');
            document.getElementById('winnerPopup').style.display = 'none';
        }

        function resetGameState() {
            gameState.gameStarted = false;
            gameState.isMyTurn = false;
            gameState.mySecret = '';
            gameState.secretSubmitted = false;
            
            document.getElementById('mySecret').value = '';
            document.getElementById('mySecret').style.display = 'inline-block';
            document.getElementById('mySecret').previousElementSibling.style.display = 'inline';
            document.querySelector('#myPlayerSection .btn').style.display = 'inline-block';
            document.getElementById('mySecretError').textContent = '';
            document.getElementById('guessInput').value = '';
            
            document.getElementById('gamePhase').style.display = 'none';
            document.getElementById('setupPhase').style.display = 'block';
            document.getElementById('winnerPopup').style.display = 'none';
            
            showNotification('‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà!', 'success');
        }

        function leaveRoom() {
            console.log('üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á');
            
            if (gameState.socket) {
                gameState.socket.emit('leaveRoom');
            }
            
            // ‡∏•‡πâ‡∏≤‡∏á session
            SessionManager.clearSession();
            
            // ‡∏´‡∏¢‡∏∏‡∏î heartbeat
            if (gameState.heartbeatInterval) {
                clearInterval(gameState.heartbeatInterval);
                gameState.heartbeatInterval = null;
            }
            
            // ‡∏ã‡πà‡∏≠‡∏ô dialogs
            hideReconnectDialog();
            hideReconnectionOverlay();
            hideSessionRestoreDialog();
            
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Å‡∏°
            gameState = {
                socket: gameState.socket,
                roomCode: '',
                playerNumber: 0,
                playerId: '',
                isMyTurn: false,
                gameStarted: false,
                mySecret: '',
                secretSubmitted: false,
                isReconnecting: false,
                reconnectAttempts: 0,
                maxReconnectAttempts: 5,
                heartbeatInterval: null,
                lastPingTime: null
            };
            
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï UI
            resetUI();
            
            document.getElementById('lobbyPhase').style.display = 'block';
            document.getElementById('setupPhase').style.display = 'none';
            document.getElementById('gamePhase').style.display = 'none';
            document.getElementById('winnerPopup').style.display = 'none';
            
            console.log('‚úÖ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô');
            showNotification('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß', 'info');
        }

        function resetUI() {
            const mySecretInput = document.getElementById('mySecret');
            const mySecretLabel = mySecretInput.previousElementSibling;
            const submitBtn = document.querySelector('#myPlayerSection .btn');
            const errorElement = document.getElementById('mySecretError');
            const guessInput = document.getElementById('guessInput');
            const guessBtn = document.querySelector('#gameSection .btn');
            
            if (mySecretInput) {
                mySecretInput.value = '';
                mySecretInput.style.display = 'inline-block';
                mySecretInput.disabled = false;
            }
            
            if (mySecretLabel) {
                mySecretLabel.style.display = 'inline';
            }
            
            if (submitBtn) {
                submitBtn.style.display = 'inline-block';
                submitBtn.disabled = false;
                submitBtn.textContent = 'üîí ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
            }
            
            if (errorElement) {
                errorElement.textContent = '';
                errorElement.style.color = '';
            }
            
            if (guessInput) {
                guessInput.value = '';
                guessInput.disabled = false;
            }
            
            if (guessBtn) {
                guessBtn.disabled = false;
                guessBtn.textContent = 'üéØ ‡∏ó‡∏≤‡∏¢';
            }
            
            document.getElementById('roomCodeInput').value = '';
            document.getElementById('joinRoomSection').style.display = 'none';
            
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏õ‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ lobby
            const lobbyBtns = document.querySelectorAll('#lobbyPhase .btn');
            lobbyBtns.forEach(btn => {
                btn.disabled = false;
                if (btn.textContent.includes('‡∏™‡∏£‡πâ‡∏≤‡∏á')) {
                    btn.textContent = 'üéÆ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
                } else if (btn.textContent.includes('‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°')) {
                    btn.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°';
                }
            });
        }

        function validateNumber(num) {
            if (!num || num.length !== 4) return false;
            if (!/^\d{4}$/.test(num)) return false;
            
            const digits = num.split('');
            const uniqueDigits = [...new Set(digits)];
            return uniqueDigits.length === 4;
        }

        // Session Restore Functions
        function showSessionRestoreDialog(sessionData) {
            const dialog = document.getElementById('sessionRestoreDialog');
            document.getElementById('restoreRoomCode').textContent = sessionData.roomCode;
            document.getElementById('restorePlayerNumber').textContent = sessionData.playerNumber;
            dialog.style.display = 'flex';
        }

        function hideSessionRestoreDialog() {
            document.getElementById('sessionRestoreDialog').style.display = 'none';
        }

        function restoreSession() {
            const sessionData = SessionManager.loadSession();
            if (!sessionData) {
                showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• session', 'error');
                hideSessionRestoreDialog();
                return;
            }
            
            gameState.roomCode = sessionData.roomCode;
            gameState.playerNumber = sessionData.playerNumber;
            gameState.playerId = sessionData.playerId;
            gameState.mySecret = sessionData.mySecret || '';
            gameState.secretSubmitted = !!sessionData.mySecret;
            
            hideSessionRestoreDialog();
            attemptGameReconnect();
        }

        function startNewSession() {
            SessionManager.clearSession();
            hideSessionRestoreDialog();
            showNotification('‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà', 'info');
        }

        // Reconnection UI Functions
        function showReconnectionOverlay() {
            document.getElementById('reconnectionOverlay').style.display = 'flex';
        }

        function hideReconnectionOverlay() {
            document.getElementById('reconnectionOverlay').style.display = 'none';
        }

        function showReconnectDialog(playerNumber, timeLeft) {
            hideReconnectDialog();
            
            const dialog = document.createElement('div');
            dialog.id = 'reconnectDialog';
            dialog.className = 'reconnect-dialog';
            dialog.innerHTML = `
                <div class="reconnect-content">
                    <h3>‚è≥ ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</h3>
                    <p>‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà ${playerNumber} ‡∏´‡∏•‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</p>
                    <div class="countdown">
                        ‡∏£‡∏≠ <span id="reconnectCountdown">${timeLeft}</span> ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                    </div>
                    <div class="reconnect-progress">
                        <div class="progress-bar" id="reconnectProgressBar" style="width: 100%"></div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
        }

        function updateReconnectCountdown(timeLeft) {
            const countdownElement = document.getElementById('reconnectCountdown');
            const progressBar = document.getElementById('reconnectProgressBar');
            
            if (countdownElement) {
                countdownElement.textContent = timeLeft;
            }
            
            if (progressBar) {
                const percentage = (timeLeft / 30) * 100; // 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                progressBar.style.width = percentage + '%';
            }
            
            if (timeLeft <= 0) {
                setTimeout(() => {
                    hideReconnectDialog();
                }, 1000);
            }
        }

        function hideReconnectDialog() {
            const dialog = document.getElementById('reconnectDialog');
            if (dialog) {
                dialog.remove();
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ UI
        function validateAndFixUI() {
            const guessBtn = document.querySelector('#gameSection .btn');
            const guessInput = document.getElementById('guessInput');
            const submitBtn = document.querySelector('#myPlayerSection .btn');
            const createBtn = document.querySelector('.btn-secondary');
            const joinBtn = document.querySelector('#joinRoomSection .btn');
            
            // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏≤‡∏¢
            if (guessBtn && guessBtn.disabled && gameState.gameStarted && gameState.isMyTurn) {
                console.log('üîß ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏≤‡∏¢');
                guessBtn.disabled = false;
                guessBtn.textContent = 'üéØ ‡∏ó‡∏≤‡∏¢';
            }
            
            // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç input ‡∏ó‡∏≤‡∏¢
            if (guessInput && guessInput.disabled && gameState.gameStarted && gameState.isMyTurn) {
                console.log('üîß ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç input ‡∏ó‡∏≤‡∏¢');
                guessInput.disabled = false;
            }
            
            // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏•‡∏±‡∏ö
            if (submitBtn && submitBtn.disabled && !gameState.secretSubmitted) {
                console.log('üîß ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏•‡∏±‡∏ö');
                submitBtn.disabled = false;
                submitBtn.textContent = 'üîí ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
            }
            
            // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á
            if (createBtn && createBtn.disabled && !gameState.roomCode) {
                console.log('üîß ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á');
                createBtn.disabled = false;
                createBtn.textContent = 'üéÆ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
            }
            
            // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°
            if (joinBtn && joinBtn.disabled && !gameState.roomCode) {
                console.log('üîß ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°');
                joinBtn.disabled = false;
                joinBtn.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°';
            }
        }

        // Utility Functions
        function copyRoomCode() {
            if (!gameState.roomCode) {
                showNotification('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å', 'error');
                return;
            }
            
            try {
                const textArea = document.createElement('textarea');
                textArea.value = gameState.roomCode;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                
                textArea.focus();
                textArea.select();
                
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                
                if (successful) {
                    showNotification(`‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á ${gameState.roomCode} ‡πÅ‡∏•‡πâ‡∏ß!`, 'success');
                } else {
                    showManualCopyDialog();
                }
            } catch (err) {
                showManualCopyDialog();
            }
        }

        function showManualCopyDialog() {
            const roomCode = gameState.roomCode;
            const message = `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ\n\n‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á: ${roomCode}\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á`;
            
            if (window.prompt) {
                prompt('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á (‡∏Å‡∏î Ctrl+C ‡∏´‡∏£‡∏∑‡∏≠ Cmd+C):', roomCode);
            } else {
                alert(message);
            }
        }

        function shareRoomCode() {
            if (!gameState.roomCode) {
                showNotification('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏ä‡∏£‡πå', 'error');
                return;
            }

            const shareText = `üéØ ‡∏°‡∏≤‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡∏ó‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç!\n\n‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á: ${gameState.roomCode}\n‡∏•‡∏¥‡∏á‡∏Å‡πå: ${window.location.origin}\n\n‡πÅ‡∏•‡πâ‡∏ß‡∏°‡∏≤‡πÄ‡∏à‡∏≠‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏Å‡∏°! üéÆ`;

            try {
                const textArea = document.createElement('textarea');
                textArea.value = shareText;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                
                textArea.focus();
                textArea.select();
                
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                
                if (successful) {
                    showNotification('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ä‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß! ‡∏ô‡∏≥‡πÑ‡∏õ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô', 'success');
                } else {
                    showShareDialog(shareText);
                }
            } catch (err) {
                showShareDialog(shareText);
            }
        }

        function showShareDialog(shareText) {
            if (window.prompt) {
                prompt('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÅ‡∏ä‡∏£‡πå (‡∏Å‡∏î Ctrl+A ‡πÅ‡∏•‡πâ‡∏ß Ctrl+C):', shareText);
            } else {
                alert(`‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô:\n\n${shareText}`);
            }
        }

        function shareNgrokLink() {
            const currentUrl = window.location.origin;
            const isNgrok = currentUrl.includes('ngrok') || currentUrl.includes('tunnel');
            
            const shareText = `üéØ ‡∏°‡∏≤‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡∏ó‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç!\n\n${isNgrok ? 'üåê ‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡πâ‡∏≤‡∏°‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï' : 'üè† ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏ô LAN'}\n\n‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á: ${gameState.roomCode}\n‡∏•‡∏¥‡∏á‡∏Å‡πå: ${currentUrl}\n\n‡πÅ‡∏•‡πâ‡∏ß‡∏°‡∏≤‡πÄ‡∏à‡∏≠‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏Å‡∏°! üéÆ`;
            
            try {
                const textArea = document.createElement('textarea');
                textArea.value = shareText;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                
                textArea.focus();
                textArea.select();
                
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                
                if (successful) {
                    showNotification('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ä‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß!', 'success');
                } else {
                    showShareDialog(shareText);
                }
            } catch (err) {
                showShareDialog(shareText);
            }
        }

        function startHeartbeat() {
            if (gameState.heartbeatInterval) {
                clearInterval(gameState.heartbeatInterval);
            }
            
            gameState.heartbeatInterval = setInterval(() => {
                if (gameState.socket && gameState.socket.connected) {
                    gameState.lastPingTime = Date.now();
                    
                    // ‡∏ï‡∏±‡πâ‡∏á timeout ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ping
                    const pingTimeout = setTimeout(() => {
                        console.log('üèì Ping timeout - ‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
                        if (!gameState.isReconnecting) {
                            updateConnectionStatus('waiting');
                        }
                    }, 5000);
                    
                    gameState.socket.emit('ping', (response) => {
                        clearTimeout(pingTimeout);
                        if (response === 'pong') {
                            const pingTime = Date.now() - gameState.lastPingTime;
                            console.log(`üèì Ping: ${pingTime}ms`);
                            
                            if (!gameState.isReconnecting) {
                                updateConnectionStatus('connected');
                            }
                        }
                    });
                } else if (!gameState.isReconnecting) {
                    console.log('üíî Socket ‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ - ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° reconnect');
                    attemptReconnection();
                }
            }, 30000); // ‡∏™‡πà‡∏á‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        }

        function showInstructions() {
            alert(`üéØ ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô - ‡πÄ‡∏Å‡∏°‡∏ó‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 4 ‡∏´‡∏•‡∏±‡∏Å

üì± ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°:
1. ‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡∏Ñ‡∏•‡∏¥‡∏Å "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà"
2. ‡πÅ‡∏ä‡∏£‡πå‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á 6 ‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô
3. ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡∏∞‡∏Ñ‡∏•‡∏¥‡∏Å "‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á"
4. ‡∏ï‡∏±‡πâ‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 4 ‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°!

üéÆ ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô:
- ‡∏ï‡∏±‡πâ‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 4 ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 1234, 5687)
- ‡∏ú‡∏•‡∏±‡∏î‡∏Å‡∏±‡∏ô‡∏ó‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Ç‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢
- "‡∏ñ‡∏π‡∏Å‡∏´‡∏•‡∏±‡∏Å" = ‡πÄ‡∏•‡∏Ç‡∏ñ‡∏π‡∏Å ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ñ‡∏π‡∏Å
- "‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏Ç" = ‡πÄ‡∏•‡∏Ç‡∏ñ‡∏π‡∏Å ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏¥‡∏î
- ‡πÉ‡∏Ñ‡∏£‡∏ó‡∏≤‡∏¢‡∏ñ‡∏π‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏ä‡∏ô‡∏∞!

üí° ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏©:
- ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏´‡∏≤‡∏Å‡∏´‡∏•‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
- ‡πÅ‡∏ä‡∏£‡πå‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡πâ‡∏≤‡∏°‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï
- ‡∏£‡∏∞‡∏ö‡∏ö Real-time WebSocket
- ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå

üöÄ ‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ: Node.js + Socket.IO`);
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            updateConnectionStatus('waiting');
            initSocket();
            
            console.log('üéÆ ‡πÄ‡∏Å‡∏°‡∏ó‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 4 ‡∏´‡∏•‡∏±‡∏Å - ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡πà‡∏ô Real-time');
            console.log('üîó ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Reconnection ‡πÅ‡∏•‡∏∞ Session Management');
        });

        // Keyboard Event Listeners
        document.getElementById('guessInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && gameState.isMyTurn && gameState.gameStarted) {
                e.preventDefault();
                makeGuess();
            }
        });

        document.getElementById('mySecret').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !gameState.secretSubmitted) {
                e.preventDefault();
                submitSecret();
            }
        });

        document.getElementById('roomCodeInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                joinRoom();
            }
        });

        // Input Validation
        document.querySelectorAll('input[type="text"]:not(.room-input)').forEach(input => {
            input.addEventListener('input', function(e) {
                this.value = this.value.replace(/[^0-9]/g, '');
            });
        });

        document.getElementById('roomCodeInput').addEventListener('input', function(e) {
            this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        });

        // Page Unload Warning
        window.addEventListener('beforeunload', function(e) {
            if (gameState.gameStarted) {
                e.preventDefault();
                e.returnValue = '‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡∏≠‡∏¢‡∏π‡πà ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?';
                return e.returnValue;
            }
        });

        // Visibility Change - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô tab
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('üëÅÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç UI
                setTimeout(() => {
                    validateAndFixUI();
                    
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
                    if (gameState.roomCode && (!gameState.socket || !gameState.socket.connected) && !gameState.isReconnecting) {
                        attemptReconnection();
                    }
                }, 500);
            }
        });

        // Online/Offline Detection
        window.addEventListener('online', function() {
            console.log('üåê ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß');
            updateConnectionStatus('waiting');
            
            setTimeout(() => {
                if (gameState.roomCode && (!gameState.socket || !gameState.socket.connected) && !gameState.isReconnecting) {
                    attemptReconnection();
                }
                validateAndFixUI();
            }, 1000);
        });

        window.addEventListener('offline', function() {
            console.log('üì° ‡∏´‡∏•‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï');
            updateConnectionStatus('disconnected');
        });

        // Auto-reconnect on focus
        window.addEventListener('focus', function() {
            if (gameState.roomCode && gameState.socket && !gameState.socket.connected && !gameState.isReconnecting) {
                console.log('üîç ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ focus - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
                setTimeout(() => {
                    if (!gameState.socket.connected && !gameState.isReconnecting) {
                        attemptReconnection();
                    }
                    validateAndFixUI();
                }, 1000);
            }
        });

        // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç UI ‡∏ó‡∏∏‡∏Å‡πÜ 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        setInterval(() => {
            if (gameState.socket && gameState.socket.connected) {
                validateAndFixUI();
            }
        }, 5000);

        // Initialize on load
        console.log('‚úÖ ‡πÄ‡∏Å‡∏°‡∏ó‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 4 ‡∏´‡∏•‡∏±‡∏Å ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
        console.log('üìä ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå: Real-time, Reconnection, Session Management, Auto UI Fix');
        console.log('üîß ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç UI ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
    </script>
</body>
</html>